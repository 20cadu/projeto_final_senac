{% extends 'app/base.html' %}
{% block title %}Cadastro de Produtos{% endblock %}
{% block content %}
<section>
  <h3 class="mx-4 mt-3" style="color: white">Cadastro de produtos:</h3>
  <div class="container mt-4">
    <form id="produto-form" method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit">Adicionar Produto</button>
    </form>

    <h4 class="mt-5" style="color: white;">Produtos cadastrados:</h4>
    <ul>
      {% for produto in produtos %}
        <li>{{ produto.nome }}</li>
      {% empty %}
        <li style="color: white;">Nenhum produto cadastrado.</li>
      {% endfor %}
    </ul>
  </div>
</section>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('produto-form');

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const formData = new FormData(form);

      fetch('produtos', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
    .then(response => {
      if (!response.ok) {
        // Tenta ler json com erro
        return response.json().then(errData => {
          throw new Error(JSON.stringify(errData.errors || errData));
        });
      }
      return response.json();
    })
    .then(data => {
      // Redireciona para main apÃ³s cadastrar
      window.location.href = '/';
    })
    .catch(error => {
      alert('Erro ao adicionar produto:\n' + error.message);
      console.error('Erro:', error);
    });
  });
});
</script>
{% endblock %}